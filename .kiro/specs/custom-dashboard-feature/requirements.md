# 自定义仪表板功能需求文档

## 1. 功能概述

为 Cloudflare Analytics 应用添加自定义仪表板功能，允许用户通过拖拽排序和显示/隐藏来个性化他们的仪表板视图。

## 2. 用户故事

### 2.1 作为用户，我希望能够拖拽排序指标卡片
**验收标准**:
- 用户可以长按指标卡片进入编辑模式
- 在编辑模式下可以拖拽卡片改变顺序
- 拖拽时有视觉反馈（卡片跟随手指移动）
- 松开手指后卡片固定在新位置
- 排序设置自动保存

### 2.2 作为用户，我希望能够显示/隐藏指标卡片
**验收标准**:
- 用户可以选择显示或隐藏特定的指标卡片
- 隐藏的卡片不在仪表板上显示
- 可以在设置中重新显示已隐藏的卡片
- 至少保留一个可见卡片

### 2.3 作为用户，我希望能够保存多个仪表板布局
**验收标准**:
- 用户可以创建多个命名的仪表板布局
- 可以在不同布局之间快速切换
- 每个布局保存独立的卡片顺序和可见性设置
- 可以重命名或删除布局

### 2.4 作为用户，我希望能够重置为默认布局
**验收标准**:
- 提供"重置为默认"选项
- 重置后恢复到初始的卡片顺序和可见性
- 重置前有确认提示

## 3. 功能需求

### 3.1 可自定义的指标卡片

支持以下指标卡片的自定义：

**流量指标**:
- 总请求数
- 数据传输量
- 带宽
- 页面浏览量
- 访问次数

**安全指标**:
- 缓存命中率
- 防火墙事件总数
- 被阻止的请求
- 受挑战的请求
- Bot 流量百分比

**状态码**:
- 2xx 成功率
- 4xx 客户端错误
- 5xx 服务器错误

**地理分布**:
- Top 5 国家/地区

### 3.2 拖拽功能

- 使用 `react-native-draggable-flatlist` 库
- 长按触发拖拽（500ms）
- 拖拽时卡片放大 1.05 倍
- 拖拽时显示阴影效果
- 其他卡片自动让位

### 3.3 编辑模式

- 编辑按钮切换编辑/查看模式
- 编辑模式下：
  - 卡片显示拖拽手柄图标
  - 卡片显示可见性切换开关
  - 卡片轻微抖动动画
- 查看模式下：
  - 正常显示数据
  - 不显示编辑控件

### 3.4 布局管理

- 布局列表界面
- 创建新布局（输入名称）
- 切换布局（下拉选择）
- 重命名布局
- 删除布局（不能删除最后一个）
- 复制布局

### 3.5 数据持久化

- 使用 AsyncStorage 保存配置
- 存储结构：
```typescript
{
  layouts: {
    [layoutId: string]: {
      id: string;
      name: string;
      cards: Array<{
        id: string;
        type: string;
        visible: boolean;
        order: number;
      }>;
      createdAt: Date;
      updatedAt: Date;
    }
  },
  activeLayoutId: string;
}
```

## 4. 技术实现

### 4.1 依赖库

```bash
npm install react-native-draggable-flatlist
npm install react-native-gesture-handler
npm install react-native-reanimated
```

### 4.2 文件结构

```
src/
├── contexts/
│   └── DashboardContext.tsx      # 仪表板配置 Context
├── components/
│   ├── DraggableMetricCard.tsx   # 可拖拽的指标卡片
│   ├── MetricCardContent.tsx     # 指标卡片内容
│   └── LayoutSelector.tsx        # 布局选择器
├── screens/
│   ├── CustomDashboardScreen.tsx # 自定义仪表板主屏幕
│   └── LayoutManagerScreen.tsx   # 布局管理屏幕
├── services/
│   └── DashboardConfigManager.ts # 配置管理服务
└── types/
    └── dashboard.ts              # 类型定义
```

### 4.3 核心组件

#### DashboardContext
- 管理当前布局配置
- 提供布局切换方法
- 提供卡片排序方法
- 提供卡片可见性切换方法

#### DraggableMetricCard
- 可拖拽的卡片容器
- 编辑模式切换
- 拖拽手柄
- 可见性开关

#### MetricCardContent
- 根据卡片类型渲染不同内容
- 显示实时数据
- 支持深色模式

## 5. 用户界面

### 5.1 仪表板主屏幕

```
┌─────────────────────────────────┐
│ 自定义仪表板        [编辑] [⚙️] │
├─────────────────────────────────┤
│ 布局: 默认布局 ▼                │
├─────────────────────────────────┤
│ ┌─────────────┐ ┌─────────────┐ │
│ │ 总请求数    │ │ 数据传输    │ │
│ │ 1.2M        │ │ 45.3 GB     │ │
│ └─────────────┘ └─────────────┘ │
│ ┌─────────────┐ ┌─────────────┐ │
│ │ 缓存命中率  │ │ 带宽        │ │
│ │ 85.3%       │ │ 2.3 MB/s    │ │
│ └─────────────┘ └─────────────┘ │
│ ┌─────────────────────────────┐ │
│ │ 防火墙事件                  │ │
│ │ 被阻止: 234  受挑战: 56     │ │
│ └─────────────────────────────┘ │
└─────────────────────────────────┘
```

### 5.2 编辑模式

```
┌─────────────────────────────────┐
│ 编辑仪表板        [完成] [⚙️]   │
├─────────────────────────────────┤
│ 长按拖拽以重新排序              │
├─────────────────────────────────┤
│ ┌─────────────┐ ┌─────────────┐ │
│ │☰ 总请求数 ✓│ │☰ 数据传输 ✓│ │
│ │ 1.2M        │ │ 45.3 GB     │ │
│ └─────────────┘ └─────────────┘ │
│ ┌─────────────┐ ┌─────────────┐ │
│ │☰ 缓存命中率✓│ │☰ 带宽     ✗│ │
│ │ 85.3%       │ │ (已隐藏)    │ │
│ └─────────────┘ └─────────────┘ │
└─────────────────────────────────┘
```

### 5.3 布局管理屏幕

```
┌─────────────────────────────────┐
│ ← 布局管理              [+ 新建] │
├─────────────────────────────────┤
│ ✓ 默认布局                      │
│   8 个可见卡片                  │
│   最后编辑: 2小时前       [⋯]  │
├─────────────────────────────────┤
│   工作布局                      │
│   5 个可见卡片                  │
│   最后编辑: 1天前         [⋯]  │
├─────────────────────────────────┤
│   安全监控                      │
│   6 个可见卡片                  │
│   最后编辑: 3天前         [⋯]  │
└─────────────────────────────────┘
```

## 6. 非功能需求

### 6.1 性能
- 拖拽响应时间 < 16ms (60fps)
- 布局切换时间 < 100ms
- 配置保存时间 < 50ms

### 6.2 可用性
- 拖拽操作直观易懂
- 提供操作提示和引导
- 支持撤销操作

### 6.3 兼容性
- iOS 13+ 支持
- Android 10+ 支持
- 支持深色模式

## 7. 实施步骤

### Phase 1: 基础设施（2-3天）
1. 安装依赖库
2. 创建 DashboardContext
3. 创建 DashboardConfigManager
4. 定义类型和接口

### Phase 2: 核心功能（3-4天）
5. 实现可拖拽卡片组件
6. 实现编辑模式切换
7. 实现卡片可见性控制
8. 实现配置持久化

### Phase 3: 布局管理（2-3天）
9. 实现布局列表界面
10. 实现布局创建/删除
11. 实现布局切换
12. 实现布局重命名

### Phase 4: 优化和测试（1-2天）
13. 性能优化
14. 动画优化
15. 用户体验优化
16. Bug 修复

## 8. 风险和挑战

### 8.1 风险
- 拖拽库可能与现有导航冲突
- 性能问题（大量卡片时）
- 手势识别冲突

### 8.2 缓解措施
- 提前测试库的兼容性
- 实现虚拟化列表
- 仔细配置手势优先级

## 9. 成功指标

- [ ] 用户可以流畅地拖拽排序卡片
- [ ] 配置正确保存和恢复
- [ ] 支持多个布局
- [ ] 性能达标（60fps）
- [ ] 用户满意度 > 85%

## 10. 后续优化

- 添加更多指标卡片类型
- 支持卡片大小调整
- 支持导出/导入布局配置
- 支持布局分享
- 添加预设布局模板

---

*创建时间: 2026-01-26*
*预计工期: 8-12天*
